/**
 * è‡ªå®šä¹‰æ’ä»¶å¼€å‘ç¤ºä¾‹
 */

import {
  definePlugin,
  Generator,
  logger,
  type Plugin,
  type PluginContext,
  type GenerateResult
} from '../src'

// ===== ç¤ºä¾‹ 1: ç®€å•çš„æ—¥å¿—æ’ä»¶ =====
const loggingPlugin: Plugin = definePlugin({
  name: 'logging-plugin',
  version: '1.0.0',
  description: 'è®°å½•æ‰€æœ‰ç”Ÿæˆæ“ä½œçš„æ’ä»¶',

  hooks: {
    beforeGenerate: async (context: PluginContext) => {
      logger.info(`å³å°†ç”Ÿæˆ: ${context.templateName}`)
    },

    afterGenerate: async (context: PluginContext, result: GenerateResult) => {
      if (result.success) {
        logger.info(`ç”ŸæˆæˆåŠŸ: ${result.outputPath}`)
      }
    },

    onError: async (context: PluginContext, error: Error) => {
      logger.error(`ç”Ÿæˆå¤±è´¥: ${context.templateName}`, error)
    }
  }
})

// ===== ç¤ºä¾‹ 2: ä»£ç æ³¨å…¥æ’ä»¶ =====
const codeInjectionPlugin: Plugin = definePlugin({
  name: 'code-injection-plugin',
  version: '1.0.0',
  description: 'åœ¨ç”Ÿæˆçš„ä»£ç ä¸­æ³¨å…¥è‡ªå®šä¹‰å†…å®¹',
  config: {
    header: '// Auto-generated by LDesign Generator',
    footer: '// End of generated code'
  },

  hooks: {
    onTemplateRender: async (context: PluginContext, content: string) => {
      const header = context.config?.header || '// Auto-generated'
      const footer = context.config?.footer || ''

      return `${header}\n\n${content}\n\n${footer}`
    }
  }
})

// ===== ç¤ºä¾‹ 3: ç‰ˆæƒä¿¡æ¯æ’ä»¶ =====
const copyrightPlugin: Plugin = definePlugin({
  name: 'copyright-plugin',
  version: '1.0.0',
  description: 'æ·»åŠ ç‰ˆæƒä¿¡æ¯',
  config: {
    author: 'LDesign Team',
    license: 'MIT',
    year: new Date().getFullYear()
  },

  hooks: {
    onTemplateRender: async (context: PluginContext, content: string) => {
      const { author, license, year } = context.config || {}

      const copyright = `/**
 * Copyright (c) ${year} ${author}
 * Licensed under ${license}
 * 
 * Generated by: @ldesign/generator
 * Template: ${context.templateName}
 * Date: ${new Date().toISOString()}
 */

`

      return copyright + content
    }
  }
})

// ===== ç¤ºä¾‹ 4: æ–‡ä»¶å¤§å°æ£€æŸ¥æ’ä»¶ =====
const fileSizeCheckPlugin: Plugin = definePlugin({
  name: 'file-size-check-plugin',
  version: '1.0.0',
  description: 'æ£€æŸ¥ç”Ÿæˆæ–‡ä»¶çš„å¤§å°',
  config: {
    maxSize: 1024 * 100 // 100KB
  },

  hooks: {
    afterGenerate: async (context: PluginContext, result: GenerateResult) => {
      if (!result.success || !result.outputPath) return

      const fs = await import('fs-extra')
      const stats = await fs.stat(result.outputPath)
      const maxSize = context.config?.maxSize || 102400

      if (stats.size > maxSize) {
        logger.warn(`æ–‡ä»¶è¿‡å¤§: ${result.outputPath} (${stats.size} bytes)`, {
          maxSize,
          actualSize: stats.size
        })
      }
    }
  }
})

// ===== ç¤ºä¾‹ 5: Git è‡ªåŠ¨æäº¤æ’ä»¶ =====
const gitAutoCommitPlugin: Plugin = definePlugin({
  name: 'git-auto-commit-plugin',
  version: '1.0.0',
  description: 'è‡ªåŠ¨æäº¤ç”Ÿæˆçš„æ–‡ä»¶åˆ° Git',
  config: {
    enabled: false, // é»˜è®¤ç¦ç”¨
    commitMessage: 'chore: generate code via @ldesign/generator'
  },

  hooks: {
    afterGenerate: async (context: PluginContext, result: GenerateResult) => {
      if (!context.config?.enabled) return
      if (!result.success || !result.outputPath) return

      const { exec } = await import('child_process')
      const { promisify } = await import('util')
      const execAsync = promisify(exec)

      try {
        // æ·»åŠ æ–‡ä»¶
        await execAsync(`git add ${result.outputPath}`)

        // æäº¤
        const message = context.config?.commitMessage || 'chore: generate code'
        await execAsync(`git commit -m "${message}"`)

        logger.info(`æ–‡ä»¶å·²è‡ªåŠ¨æäº¤åˆ° Git: ${result.outputPath}`)
      } catch (error) {
        logger.warn('Git è‡ªåŠ¨æäº¤å¤±è´¥', { error: (error as Error).message })
      }
    }
  }
})

// ===== ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶ =====
async function demo() {
  console.log('ğŸ¨ è‡ªå®šä¹‰æ’ä»¶ç¤ºä¾‹\n')

  const generator = new Generator({
    templateDir: './templates',
    outputDir: './output/custom',
    plugins: [
      loggingPlugin,
      codeInjectionPlugin,
      copyrightPlugin,
      fileSizeCheckPlugin
      // gitAutoCommitPlugin // éœ€è¦æ—¶å¯ç”¨
    ]
  })

  // ç”Ÿæˆæ–‡ä»¶
  const result = await generator.generate('vue/component.ejs', {
    componentName: 'CustomComponent',
    outputFileName: 'CustomComponent.vue'
  })

  console.log(`\nâœ“ ç”Ÿæˆå®Œæˆ: ${result.outputPath}`)
  console.log('\nğŸ“Š æ’ä»¶ç»Ÿè®¡:')

  const pluginManager = generator.getPluginManager()
  const stats = pluginManager.getStats()

  console.log(`  æ€»æ’ä»¶æ•°: ${stats.total}`)
  console.log(`  å·²åŠ è½½: ${stats.loaded}`)
  stats.plugins.forEach(p => {
    console.log(`  - ${p.name} (${p.loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'})`)
  })
}

// ===== å¯¼å‡ºæ’ä»¶ä¾›å…¶ä»–é¡¹ç›®ä½¿ç”¨ =====
export {
  loggingPlugin,
  codeInjectionPlugin,
  copyrightPlugin,
  fileSizeCheckPlugin,
  gitAutoCommitPlugin
}

// è¿è¡Œæ¼”ç¤º
if (require.main === module) {
  demo().catch(console.error)
}

